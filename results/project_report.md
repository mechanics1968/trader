# デイトレーダー支援システム 取り組みレポート

**作成日**: 2026-02-25
**対象期間**: システム構築開始〜現在
**ステータス**: Phase 1（LightGBM）完成・Phase 2（TFT）実装済み・運用適用保留

---

## 1. プロジェクト概要

東証全銘柄（プライム・スタンダード・グロース、約3,776銘柄）を対象に、
翌営業日の株価（始値・終値）を機械学習で予測し、当日中に決済するデイトレード向け銘柄を推薦するシステムを構築した。

**取引ルール**
- 前場寄り付き（09:00頃）に取得 → 後場引け（15:30）までに決済（持ち越し禁止）
- 元手 200万円 / 1銘柄あたり上限 40万円（元手の20%）

---

## 2. システム構成

```
trader/
├── main.py                      # エントリポイント（Step1〜9）
├── config.py                    # 全設定値
├── walk_forward_backtest.py     # ウォークフォワード・バックテスト
├── data/
│   ├── raw/                     # Yahoo Finance 生データ（日次 OHLCV）
│   ├── processed/               # 特徴量エンジニアリング済みデータ
│   └── tickers/tse_tickers.csv  # 東証全銘柄コード一覧（JPX取得）
├── src/
│   ├── fetch/                   # データ取得（銘柄コード・株価・単元株数）
│   ├── features/engineer.py     # テクニカル指標・特徴量生成（taライブラリ）
│   ├── models/
│   │   ├── train.py             # LightGBM 学習
│   │   ├── predict.py           # 翌日予測
│   │   ├── evaluate.py          # 評価・バックテスト
│   │   ├── optimize.py          # Optuna 多目的ハイパーパラメータ最適化
│   │   ├── tft_model.py         # TFT モデルラッパー
│   │   ├── tft_train.py         # TFT 学習
│   │   └── tft_predict.py       # TFT 予測
│   ├── strategy/recommend.py    # 推薦銘柄リスト生成
│   └── report/output.py         # CSV + Markdown 出力
└── scripts/daily_run.sh         # 毎日引け後 cron スクリプト
```

---

## 3. 実装した機能

### 3.1 データパイプライン
- JPX公式 Excel から東証全銘柄コード（3,776銘柄）を取得
- yfinance（v1.2.0以上）で直近1年分の日次 OHLCV を並列取得（10スレッド）
- レートリミット対策としてリトライ処理・スリープを実装

### 3.2 特徴量エンジニアリング（約85列）

| カテゴリ | 指標 |
|----------|------|
| トレンド | SMA(5,20,60), EMA(12,26), MACD, ADX |
| モメンタム | RSI(14), Stochastic(14), Williams %R |
| ボラティリティ | ATR(14), Bollinger Bands(20), 標準偏差 |
| 出来高 | OBV, 出来高移動平均比, 出来高前日比 |
| 価格変化 | 前日比騰落率, 始値-終値ギャップ, 高値-安値レンジ |
| 市場・セクター | 市場平均リターン, セクター相対リターン, 前日市場リターン |
| ラグ特徴量 | 1, 2, 3, 5日前の各指標 |

- 特徴量はすべて比率ベースに統一（銘柄間スケール差の排除）
- ターゲット変数: ±20%超の1日変動行を除外してモデルを安定化

### 3.3 予測モデル

#### Phase 1: LightGBM（完成）
- 全3,776銘柄共通の単一グローバルモデル
- 予測ターゲット: 翌日始値・終値の前日終値比変化率（超過リターン α）
- 学習データ: 直近1年分（約250営業日）
- バリデーション: 最後の20日分（全銘柄 × 20日）を保持

#### Phase 2: TFT - Temporal Fusion Transformer（実装済み・未評価）
- ライブラリ: pytorch-forecasting v1.x
- `TimeSeriesDataSet(group_ids=["ticker"])` で全銘柄グローバルモデル
- `--model tft` フラグで切り替え可能（既存 LightGBM パスは無変更）
- M1 Mac MPS バックエンド対応（`PYTORCH_ENABLE_MPS_FALLBACK=1`）
- 学習時間が長いため本格評価は未実施

### 3.4 ハイパーパラメータ最適化（Optuna NSGA-II）
- 多目的最適化（5目的）:
  1. 始値 RMSE 最小化
  2. 終値 RMSE 最小化
  3. 始値方向的中率 最大化（1-acc を最小化）
  4. 終値方向的中率 最大化（1-acc を最小化）
  5. 推薦銘柄数 最大化（負値を最小化）
- 選択基準: Pareto 前線の中で「推薦数 ≥ 5」を満たし終値方向的中率が最大のパラメータ
- `n_jobs > 1` 並列実行対応（SQLite 自動フォールバック）
- 固定ラウンド数 `OPT_NUM_ROUNDS=50`、Early Stopping 無効（`OPT_EARLY_STOPPING=None`）

### 3.5 推薦ロジック
```
期待上昇率 = (予測終値 - 予測始値) / 予測始値 × 100

フィルタ条件:
  - 期待上昇率 >= 0.5%
  - 出来高 >= 100,000 株
  - 前日比騰落率 <= ±10%
  - （前日市場リターンが閾値未満の日は全件除外）

ソート: 期待上昇率の高い順に上位 20 件
```

### 3.6 ウォークフォワード・バックテスト
- 直近50営業日を対象に毎日モデルを再学習して予測
- 情報漏洩なし: 日付 ≤ T-2 のデータで学習 → T-1 の特徴量で T を予測 → 実績と比較

---

## 4. 精度評価結果

### 4.1 ウォークフォワード・バックテスト（直近50日）

| 指標 | 結果 |
|------|------|
| 終値方向的中率（全銘柄） | 約50〜51% |
| 期待上昇的中率（全銘柄） | 約49〜51% |
| 推薦銘柄 勝率（最良） | **46.7%**（50日間・フィルタあり） |
| 推薦銘柄 勝率（最悪） | 42.2%（設定ミス時） |
| 平均市場リターン | +0.03〜+0.07%/日 |

### 4.2 市場状況別の勝率分解

| 市場状況 | 推薦勝率 |
|----------|----------|
| 市場上昇日（前日リターン ≥ 0） | 約 50.6% |
| 市場下落日（前日リターン < 0） | 約 35.9% |

市場下落日に推薦勝率が大きく落ちる傾向が確認されたが、
`MARKET_DECLINE_THRESHOLD` を `-1.0`（事実上無効）に設定しているため現在は市場フィルタが機能していない。
（単純な前日リターン閾値はリバウンド日を除外してしまうため逆効果と判断し無効化）

### 4.3 実用ラインとの比較

| 指標 | 実用ライン | 最良結果 | 差分 |
|------|-----------|---------|------|
| 推薦勝率（期待利益幅方向） | **55%以上** | **46.7%** | **-8.3pt** |
| 終値方向的中率 | 55%以上 | 51% | -4pt |

**現時点では実用ラインに届いていない。**

---

## 5. デバッグ・改善の経緯

### 5.1 発見・修正したバグ

| # | バグ | 原因 | 対策 |
|---|------|------|------|
| 1 | 全 Trial が同一結果 | バリデーション分割が位置ベース（最終銘柄の末尾20行のみ）だった | 日付ベース分割に修正 |
| 2 | 全 Trial がヌルモデル | `min_gain_to_split` の探索範囲 0〜1.0 が広すぎ、≥0.1 で木が生成されない | 探索範囲を `1e-8〜0.05`（対数スケール）に絞る |
| 3 | Early Stopping が方向的中率を破壊 | RMSE最小化のEarly Stoppingが1〜5ラウンドで発火し全パラメータがヌルモデルに収束 | `OPT_NUM_ROUNDS=50`、`OPT_EARLY_STOPPING=None` に変更 |
| 4 | バックテストと最適化の設定不一致 | バックテストがデフォルト設定（1000ラウンド + Early Stopping=50）を使用 | 最適化定数 `OPT_NUM_ROUNDS/OPT_EARLY_STOPPING` をバックテストでも使用 |
| 5 | `n_jobs>1` で segfault / 異常終了 | NSGAIISampler がインメモリストレージで並列動作不可、NFS上のSQLiteも不安定 | SQLite 自動フォールバック + OpenMP スレッド数制限（`OMP_NUM_THREADS` 設定） |
| 6 | LightGBM に ticker 列が混入 | object 型の列を特徴量に含めていた | `get_feature_columns()` で数値型のみ返すよう修正 |

### 5.2 試みたが効果がなかったアプローチ

| アプローチ | 結果 |
|-----------|------|
| クロスセクション z-score 標準化ターゲット (`USE_CS_TARGET=True`) | 絶対勝率の改善なし → 無効化 |
| 市場下落フィルタ (`MARKET_DECLINE_THRESHOLD`) | リバウンド日を除外してしまい逆効果 → -1.0（無効）に設定 |
| 別計算機での最適化パラメータ適用 | 43.9%（本機の46.7%より低下）/ 弱い正則化・深い木が過学習を誘発 |

---

## 6. 技術スタック

| 用途 | ライブラリ・バージョン |
|------|----------------------|
| データ取得 | yfinance >= 1.2.0, pandas, requests |
| テクニカル指標 | ta（pandas-ta は Python 3.9 非対応のため不採用） |
| 機械学習 | lightgbm, scikit-learn |
| ハイパーパラメータ最適化 | optuna（NSGA-II, 多目的） |
| 深層学習（TFT） | pytorch-forecasting >= 1.0.0, torch >= 2.2.0 |
| 処理系 | Python 3.9 / conda 仮想環境 `trade` |
| 実行環境 | macOS（M1 MPS）/ Linux HPC（x86_64） |

---

## 7. 残課題と今後の方向性

### 7.1 精度向上に向けた優先候補

1. **特徴量の質の改善**
   - 決算発表日フラグ（決算前後の異常値除去）
   - 信用倍率・空売り残データの追加
   - セクター ETF の相対強度
   - 夜間先物・ADR（米国上場の日本企業株）との連動指標

2. **モデルアーキテクチャ**
   - TFT の本格評価（学習時間確保が必要）
   - アンサンブル（LightGBM + TFT の予測を組み合わせる）
   - iTransformer（多変量時系列に特化した 2024 年提案モデル）

3. **損失関数・ターゲット設計**
   - 方向的中率を直接最適化する損失関数（quantile loss など）
   - 始値・終値の同時予測（マルチタスク学習）

4. **運用ロジック**
   - ケリー基準による投資比率最適化
   - 推薦銘柄のポートフォリオ相関を考慮した分散投資

### 7.2 精度目標

| フェーズ | 目標 | 現在 |
|---------|------|------|
| 運用開始ライン | 推薦勝率 55% | 46.7%（達成できず） |
| 実用ライン | 推薦勝率 60% | 未達 |

---

## 8. まとめ

- **構築したもの**: データ取得〜特徴量生成〜LightGBM学習〜予測〜推薦〜評価のフルパイプラインを完成させた。TFT（Phase 2）の実装も完了した。
- **達成できなかったもの**: 推薦勝率55%以上の運用適用ライン。最良で46.7%（直近50日間）にとどまった。
- **根本的な困難**: 株価予測のシグナル/ノイズ比が極めて低く、テクニカル指標のみでは方向性を安定して予測することが困難。特徴量の質（ファンダメンタル・需給・イベント情報）の強化が次のブレークスルーの鍵と考えられる。
