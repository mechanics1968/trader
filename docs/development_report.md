# デイトレーダー支援システム 開発レポート

**作成日**: 2026-02-24
**対象期間**: Phase 1（LightGBM ベースライン）〜 現在

---

## 1. 開発方針

### 1.1 プロジェクト概要

東証全銘柄（プライム・スタンダード・グロース、約 3,776 銘柄）を対象に、
AI が翌営業日の株価（始値・終値）を予測し、デイトレード向けの推薦銘柄リストを毎日生成するシステム。

| 項目 | 仕様 |
|---|---|
| 元手 | 200 万円 |
| 取引スタイル | 前場始値で取得 → 後場終値で売却（当日決済・持ち越し禁止） |
| 対象市場 | 東証プライム / スタンダード / グロース |
| 1 銘柄投資上限 | 元手の 20%（400,000 円）以内 |
| 損切りライン | 始値比 −2%（手動ルール） |

### 1.2 モデル選定方針

> 「株価予測の難しさの本質はモデルの複雑さではなく、シグナル/ノイズ比の低さにある。
> 方向的中率 55% 以上を実用ラインとし、段階的にモデルを高度化する。」

- **Phase 1（完了）**: LightGBM ベースライン — 高速・解釈しやすく、特徴量の重要度確認に優れる
- **Phase 2（設計済）**: Temporal Fusion Transformer (TFT) — 時系列の順序を直接扱いマルチホライズン予測が可能
- **Phase 3（将来）**: 時系列基盤モデル（Chronos, TimesFM）のファインチューニング

### 1.3 評価指標

| 指標 | 説明 |
|---|---|
| **推薦勝率** | 推薦銘柄のうち当日の日中変動（始値→終値）がプラスだった割合 |
| 終値方向的中率 | 終値の上昇/下落方向が合致した割合 |
| 期待上昇的中率 | `expected_gain_pct` の符号が実際と一致した割合 |
| 終値 RMSE | 終値変化率の予測誤差（%） |

**実用ライン**: 推薦勝率 55% 以上（ランダム 50% に対して有意差）

---

## 2. システム構成

```
trader/
├── config.py                  # 全設定値（資金・リスク・モデルパラメータ）
├── main.py                    # 実行エントリポイント（Step 1〜9）
├── walk_forward_backtest.py   # ウォークフォワード・バックテスト
├── data/
│   ├── raw/                   # Yahoo Finance 生データ（日次）
│   ├── processed/             # 特徴量エンジニアリング済みデータ
│   └── tickers/tse_tickers.csv # 東証全銘柄一覧
└── src/
    ├── fetch/                 # データ取得（tickers / prices / lot_size）
    ├── features/engineer.py   # テクニカル指標・特徴量生成
    ├── models/                # 学習 / 推論 / 評価
    ├── strategy/recommend.py  # 推薦銘柄フィルタリング
    └── report/output.py       # CSV / Markdown 出力
```

### 2.1 毎日の実行フロー

```
[引け後 15:30〜]
  Step 1. 東証銘柄コード一覧取得（週1回更新）
  Step 2. Yahoo Finance から全銘柄の OHLCV 取得（並列・10スレッド）
  Step 3. 特徴量エンジニアリング（テクニカル指標 + 市場/セクター相対値）
  Step 4. LightGBM で翌日の始値・終値を予測
  Step 5. フィルタリング → 上位 20 件を推薦
  Step 6. results/{日付}/ に CSV / Markdown で出力
```

---

## 3. 特徴量エンジニアリング

### 3.1 実装した特徴量（70 列）

| カテゴリ | 特徴量 |
|---|---|
| **価格変化率** | return_1d, return_2d, return_5d, open_close_ratio, high_low_ratio, gap_ratio |
| **トレンド** | SMA(5,20,60) + 乖離率, EMA(12,26), MACD/Signal/Hist, ADX |
| **モメンタム** | RSI(14), Stochastic(14), Williams %R |
| **ボラティリティ** | ATR(14) + ATR比率, Bollinger Bands(上/下/幅/位置), std_5, std_20 |
| **出来高（比率ベース）** | volume_ratio_5, volume_ratio_20, volume_change, obv_change |
| **ラグ特徴量** | close_lag{1,2,3,5}_ratio, return_lag{1,2,3,5}, volume_lag{1,2,3,5}_ratio |
| **セクター相対** | sector_return_1d/5d, rel_return_1d/5d（業種平均との乖離） |
| **市場相対** | mkt_return_1d/5d（等加重市場平均）, rel_to_mkt_1d/5d, beta_20d, alpha_1d |
| **追加特徴量** | intraday_return, intraday_return_lag1, vol_spike_flag, dist_running_high/low |

### 3.2 設計上の重要な決定

- **絶対値禁止**: 生株価・生出来高をそのまま使うと銘柄間のスケール差でモデルが破綻する
  → すべての特徴量を「比率ベース」で統一
- **外れ値除外**: `mkt_return_1d` の計算で ±50% 超の変動（上場廃止・株式分割等の異常値）を除外
  → `.where(abs() <= 0.50)` を適用

### 3.3 ターゲット変数

| 変数名 | 定義 | 用途 |
|---|---|---|
| `target_open_return` | `open.shift(-1) / close - 1` | 翌日始値予測 |
| `target_close_return` | `close.shift(-1) / close - 1` | 翌日終値予測（Phase 1 メイン） |
| `target_intraday_return` | `close.shift(-1) / open.shift(-1) - 1` | 日中変動予測（試験中） |

---

## 4. モデル（LightGBM）

### 4.1 学習設計

- **全銘柄共通モデル**: 3,776 銘柄の特徴量を縦結合して 1 つのモデルで学習
- **2 モデル構成**: `model_open`（始値予測）と `model_close`（終値 or 日中変動予測）を独立学習
- **ターゲットクリップ**: ±20% 超の1日変動行を除外（異常値によるモデル不安定化を防止）
- **バリデーション**: 末尾 20 日分をホールドアウトとして Early Stopping に使用

### 4.2 ハイパーパラメータ

```python
LGBM_PARAMS = {
    "objective": "regression",
    "metric": "rmse",
    "learning_rate": 0.05,
    "num_leaves": 63,
    "min_child_samples": 20,
    "feature_fraction": 0.8,
    "bagging_fraction": 0.8,
    "bagging_freq": 1,
}
LGBM_NUM_ROUNDS = 1000
LGBM_EARLY_STOPPING = 50
```

### 4.3 推薦フィルタ条件

| フィルタ | 条件 |
|---|---|
| 最低出来高 | ≥ 100,000 株 |
| 最低期待上昇率 | `expected_gain_pct` ≥ 0.5% |
| 最大購入金額 | 1 単元 ≤ 400,000 円 |
| 前日騰落率 | 絶対値 ≤ 10%（ギャップアップ/ダウン銘柄除外） |
| 推薦数上限 | 上位 20 件（期待上昇率順） |

---

## 5. 検証方法：ウォークフォワード・バックテスト

### 5.1 手法

情報漏洩を防ぐため、各ターゲット日 T に対して以下を繰り返す：

```
1. date ≤ T-2 の特徴量でモデルを再学習（T-1, T の情報は使わない）
2. T-1 の特徴量（最新行）で翌日 T を予測
3. raw データの T の実際の始値・終値と照合
4. 推薦銘柄の勝率（始値→終値がプラスか）を集計
```

- **テスト期間**: 直近 50 営業日（2025-12-08 〜 2026-02-20）
- **推薦条件**: フィルタ通過後、期待上昇率上位 20 件

### 5.2 評価基準

- **推薦勝率**: 実取引を模擬した主要指標（`actual_gain_pct = (終値-始値)/始値 × 100`）
- **終値方向的中率**: 前日終値比での上昇/下落方向の一致率

---

## 6. 検証結果

### 6.1 試行一覧と結果

| # | 内容 | 推薦勝率 | 判定 | 備考 |
|---|---|:---:|:---:|---|
| 0 | LightGBM 基本特徴量（初期） | ~46% | 参考 | 10日テスト、市場依存確認 |
| 1 | 市場ベータ中立化特徴量追加 | 46.7% | 採用 | beta_20d / alpha_1d 等を追加 |
| 2 | ターゲット→市場超過リターン | 29.6% | **NG** | 下記参照 |
| 3 | ターゲット→日中変動（第1回） | 41.9% | **NG** | 下記参照 |
| 4 | バックテスト 10日→50日延長 | ― | 採用 | 信頼性向上のため延長 |
| 5 | mkt_return 外れ値フィックス | ― | 採用 | +427921% 異常値を除去 |
| 6 | 市場下落フィルタ（-0.5%閾値） | ― | **NG** | 下記参照 |
| 7 | 1年データ + close_return（確定） | **47.0%** | ベスト | 外れ値フィックス + TOP_N=20 |
| 8 | 3年データへ拡張 | 42.8% | **NG** | 下記参照 |
| 9 | ターゲット→日中変動（第2回） | 44.3% | 検討中 | 3年データ上での試行 |

---

### 6.2 NG 判定の詳細経緯

#### 試行 #2: ターゲット変数を「市場超過リターン」に変更（推薦勝率 29.6%）

**意図**: `target_close_return` から等加重市場平均リターンを引いた「超過リターン」を予測すれば、
市場全体の上げ下げに左右されないモデルになるのではないか。

**実装**:
```python
# 変更前
target_close_return = close.shift(-1) / close - 1
# 変更後
target_close_return = close.shift(-1) / close - 1 - mkt_return_1d.shift(-1)
```

**問題点**:
- `target_open_return` は市場込みのまま（オーバーナイトギャップ含む）
- `target_close_return` だけを市場除きにすると、`expected_gain_pct = (pred_close - pred_open) / pred_open` が意味を失う
- 下落日に市場超過リターンが見かけ上大きくなり、推薦銘柄が急増（例: 2/13 に 74 件推薦）
  → 実際の勝率は 8% と壊滅的
- **教訓**: `target_open_return` と `target_close_return` の定義は必ず揃える必要がある

#### 試行 #3: ターゲット変数を「日中リターン（始値→終値）」に変更・第1回（推薦勝率 41.9%）

**意図**: 翌日終値の変化率（前日終値比）ではなく、翌日の「始値→終値」の日中変動を予測すれば、
始値が市場のギャップを吸収した後の個別銘柄固有の動きに集中できるのではないか。

**実装**:
```python
# model_close のターゲットを変更
target_intraday_return = close.shift(-1) / open.shift(-1) - 1
```

**問題点と経緯**:
- mkt_return の外れ値フィックスが適用される前の試行であったため、比較条件が不公平
- モデルが 41.9% で打ち止め → close_return の 46.7% より悪化
- この時点では外れ値バグ（後述）の影響を受けた学習データを使用
- **暫定判定**: 差し戻し（後に再試行）

#### 試行 #5（採用）: `mkt_return_1d` の +427921% 異常値バグ修正

**発見経緯**:
- バックテストログの `mkt_prev` 列に `+427921.45%` という明らかな異常値を発見
- 調査の結果、2/04 の取引データに株価がほぼゼロに近い銘柄が含まれており、
  `pct_change()` の除算で爆発した

**修正内容** (`src/features/engineer.py`):
```python
# Before（直接平均）
ret_1d = close_df.pct_change(1, fill_method=None).mean(axis=1)

# After（±50% 超の外れ値を除外してから平均）
ret_1d_raw = close_df.pct_change(1, fill_method=None)
clip = 0.50
ret_1d = ret_1d_raw.where(ret_1d_raw.abs() <= clip).mean(axis=1)
```

- `_compute_market_returns` と `_compute_sector_returns` の両方に適用

#### 試行 #6: 市場下落フィルタ（前日市場リターン < 閾値なら推薦なし）

**意図**: 前日の市場全体が下落している日は翌日も下落しやすいので、推薦を止める。

**実装**:
```python
MARKET_DECLINE_THRESHOLD = -0.5  # 前日市場 -0.5% 以下なら推薦しない
```

**問題点**:
- 前日下落後のリバウンド日（上昇に転じる日）を除外してしまう
- 例: 1/27（前日 -1.14%）はフィルタにより除外されるが、実際の勝率は **15/20=75%**
- フィルタなしと比べて統計的に改善せず
- **結論**: `MARKET_DECLINE_THRESHOLD = -1.0`（事実上無効）に設定
- **教訓**: 単純な前日リターン閾値は市場のリバウンド特性を無視してしまい逆効果

#### 試行 #8: データ期間を 3 年に拡張（推薦勝率 42.8%）

**意図**: 学習データを増やせばモデルの汎化性能が向上するはず。

**変更**: `config.py` の `PRICE_PERIOD = "1y"` → `"3y"`
**学習データ**: 730,000 行 → **2,185,000 行**（約 3 倍）

**結果と問題点**:
- 推薦勝率: 47.0% → **42.8%**（悪化）
- RMSE: 1.2% → **2.5%**（悪化）
- **原因分析**:
  - 3 年間には異なる市場レジームが含まれる（2022 年金利上昇局面、2023 年回復、2024 年上昇相場）
  - それぞれのレジームで株価の統計的性質が異なるため、モデルが「平均化」されてしまう
  - 直近の市場環境を学習する 1 年データの方が現在の相場に適合しやすい
- **結論**: `PRICE_PERIOD = "1y"` に戻す

#### 試行 #9: ターゲット変数を「日中リターン」に変更・第2回（推薦勝率 44.3%）

**意図**: #3 の再試行。外れ値フィックス適用後の公正な条件で評価。
また、「始値は市場のギャップを既に織り込んでいる」という仮説の下、
日中変動を直接予測することで市場ベータ依存を減らす狙い。

**実装の変更点**:
```python
# train.py: model_close のターゲット変更
y_close = combined["target_intraday_return"]  # (変更前: target_close_return)

# predict.py: 予測ロジック変更
intraday_return = float(model_close.predict(X)[0])
pred_open = last_close * (1 + open_return)
pred_close = pred_open * (1 + intraday_return)
expected_gain_pct = intraday_return * 100  # 日中変動が直接の取引利益
close_return_vs_prev = (1 + open_return) * (1 + intraday_return) - 1  # 方向的中率用
```

**結果**:
- 3 年データ上の公正な比較: close_return **42.8%** → intraday **44.3%**（+1.5pp 改善）
- ただし 1 年データの close_return ベースライン（47.0%）には届かず
- `model_close` の Early Stopping が 32 ラウンドと極端に少ない → 日中変動はノイズが多く学習が難しい
- 市場依存性は依然として残存（1/15=**85%** vs 2/13=**5%**）
- **評価**: 条件を揃えた 1 年データでの再試行が必要

---

### 6.3 確認されたコアの問題：市場ベータ依存性

全試行を通じて、**推薦勝率が当日の市場全体方向と強く相関する**ことが一貫して観察された。

#### 市場上昇日（50 日テスト・代表例）

| 日付 | 推薦勝率 | 市場当日 |
|---|:---:|:---:|
| 2026-01-15 | **85%** | +1.13% |
| 2026-01-27 | **75%** | +0.02% |
| 2025-12-23 | **70%** | +0.67% |

#### 市場下落日（50 日テスト・代表例）

| 日付 | 推薦勝率 | 市場当日 |
|---|:---:|:---:|
| 2026-02-13 | **5%** | −1.59% |
| 2025-12-16 | **15%** | −0.98% |
| 2026-01-28 | **15%** | −0.92% |

**根本原因の考察**:
- モデルは「この銘柄が市場平均より上がりそうか」ではなく「この銘柄が上がりそうか（絶対値）」を予測している
- 市場全体が下落する日は、ほぼすべての銘柄が下落するため、絶対値予測では回避不能
- 特徴量に市場ベータや超過リターンを追加してもこの依存性は解消されなかった

---

### 6.4 現在のベスト構成

| 項目 | 設定 |
|---|---|
| データ期間 | 1 年（`PRICE_PERIOD = "1y"`） |
| 学習データ規模 | ~730,000 行 × 70 列 |
| `model_open` ターゲット | `target_open_return`（前日終値→翌日始値） |
| `model_close` ターゲット | `target_close_return`（前日終値→翌日終値）※要再検証 |
| **推薦勝率（50 日）** | **47.0%** |
| 推薦銘柄総数 | 453 件 |

---

## 7. 未解決の課題と今後の方向性

### 7.1 未解決課題

1. **市場ベータ依存性**: 最大の問題。上昇日と下落日で推薦勝率が最大 80pp 乖離する
2. **推薦勝率が 50% を安定して超えない**: 実用ライン（55%）には届いていない
3. **日中リターンの予測困難さ**: `model_close` が 32 ラウンドで収束する → 日中変動はランダム性が高い

### 7.2 今後の改善候補

| 優先度 | 施策 | 期待効果 |
|:---:|---|---|
| 高 | **市場ニュートラルなスコアリング**: `expected_gain_pct - mkt_return` で推薦を並べ替え | ベータ依存を直接除去 |
| 高 | **1 年データ + intraday ターゲット**の公正な評価（`--refresh` 後に再検証） | 試行 #9 の本来の評価 |
| 中 | **市場方向予測の組み込み**: 市場 ETF の翌日方向を別モデルで予測し、下落確率が高い日は推薦数を絞る | 市場リスクの事前回避 |
| 中 | **Phase 2: TFT の実装と評価** | 時系列の順序情報を直接活用 |
| 低 | **決算銘柄の除外**: 決算前後の異常な値動きをフィルタ | 予測困難な銘柄を除外 |

---

## 8. 技術的知見のまとめ

| 知見 | 詳細 |
|---|---|
| pandas-ta は Python 3.9 非対応 | `ta` ライブラリを使用 |
| yfinance 0.2.40 は旧 API | 1.2.0 以上が必要 |
| pct_change() の除算爆発 | 株価がほぼゼロの銘柄が混入すると +400,000% 超の値が発生 → ±50% クリップが必要 |
| LightGBM に object 列を渡すと ValueError | `get_feature_columns()` で数値型のみフィルタ |
| target_open と target_close の定義統一 | 不整合だと expected_gain_pct が意味を失う |
| 3 年データは 1 年データより精度が低い | 異なる市場レジームを混在させると直近適合性が低下 |

---

*本レポートは 2026-02-24 時点の開発状況を反映しています。*
