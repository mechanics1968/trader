# ギャップサイズ特徴量 追加提案

作成日: 2026-02-26

---

## 背景

現在 `engineer.py` には `gap_ratio`（オーバーナイトギャップ率）と
`gap_ratio_5d_mean`（5日平均ギャップ）が実装されており、
後者は feature importance gain で始値モデル 0.8%、終値モデル 0.6% の寄与を確認している。

しかし「ギャップの大きさ」「方向」「相対的な強さ」など、
日中騰落率との非線形な関係を捉える特徴量は未実装である。

---

## ギャップサイズとは

「ギャップ」とは前日終値と当日始値の間にできる価格の飛び（窓）のこと。

```
前日終値 1,000円 → 当日始値 1,050円  →  gap_ratio = +5%（ギャップアップ）
前日終値 1,000円 → 当日始値  970円  →  gap_ratio = -3%（ギャップダウン）
```

夜間の決算発表・米国市場の動き・マクロニュースなどを織り込んで始値が決まるため、
前日終値と当日始値は必ずしも連続しない。

---

## 日中騰落率との統計的関係

ギャップ後の日中値動きには以下の傾向が知られている。

### パターン1: ギャップフィル（窓埋め）

大きくギャップアップ／ダウンした銘柄は、その後買われすぎ／売られすぎとして
**反対方向に動いて窓を埋めに行く**傾向がある。

```
例: 始値 1,050円（+5%ギャップアップ）→ 終値 1,020円（日中 -2.9%）
```

特に以下の状況でフィルが起きやすい：
- ギャップが ATR（平均真のレンジ）に対して過大なとき
- 市場全体の方向に逆行するギャップ（逆張りギャップ）

### パターン2: ギャップ継続（モメンタム）

小〜中程度のギャップアップは強いニュースを反映しており、
**日中も上昇継続**する傾向がある。

```
例: 始値 1,010円（+1%ギャップアップ）→ 終値 1,025円（日中 +1.5%）
```

特に以下の状況でモメンタムが継続しやすい：
- ギャップが市場全体の方向と一致するとき（追い風ギャップ）
- 出来高を伴うとき

### 結論

`gap_ratio` の絶対値と日中騰落率の関係は **U字型または逆U字型**になりうる非線形な関係である。
LightGBMの木構造はこの非線形関係を自動的に学習できるが、
そのためには `gap_abs`（絶対値）や `gap_vs_atr`（相対的な大きさ）を
明示的に特徴量として与えることが有効である。

---

## 提案する新規特徴量

### 実装候補

| 特徴量名 | 計算式 | 意味 | 期待効果 |
|----------|--------|------|---------|
| `gap_abs` | `abs(gap_ratio)` | ギャップの絶対値 | フィル/モメンタムの閾値判定 |
| `gap_sign` | `sign(gap_ratio)` | ギャップの方向（+1/-1/0） | 方向性の明示 |
| `gap_vs_atr` | `gap_ratio / (atr_14 / close_prev)` | ATR比ギャップ強度 | 「大きい」かどうかの相対評価 |
| `gap_abs_rank` | クロスセクショナルランク（`gap_abs`） | 銘柄間相対ギャップ大きさ | 全銘柄比較での異常値検出 |
| `gap_market_align` | `sign(gap_ratio) * sign(mkt_return_1d)` | 市場方向との一致度 | フィル vs モメンタムの識別 |

### 実装コード例

```python
# --- ギャップサイズ特徴量 ---
gap = df["gap_ratio"]  # 既存: (open - prev_close) / prev_close

# 絶対値（フィル/モメンタムの閾値判定に有効）
df["gap_abs"] = gap.abs()

# 方向
df["gap_sign"] = np.sign(gap)

# ATR比（ギャップが通常の値動き範囲に対してどれだけ大きいか）
atr_pct = df["atr_14"] / close.shift(1)
df["gap_vs_atr"] = gap / atr_pct.replace(0, np.nan)

# クロスセクショナルランク（日次で全銘柄中の相対的な大きさ）
# ※ build_features_all で日付ごとに計算する
# df["gap_abs_rank"] = ...（engineer.py の cross-sectional 処理ブロックに追加）

# 市場方向との一致（+1: 追い風ギャップ, -1: 逆張りギャップ）
# ※ mkt_return_1d は前日の市場リターン
if "mkt_return_1d" in df.columns:
    df["gap_market_align"] = np.sign(gap) * np.sign(df["mkt_return_1d"].shift(1))
```

---

## 既存特徴量との関係

| 既存特徴量 | 新特徴量 | 関係 |
|-----------|---------|------|
| `gap_ratio` | `gap_abs`, `gap_sign` | `gap_ratio` を分解。非線形効果を明示化 |
| `gap_ratio_5d_mean` | `gap_vs_atr` | 銘柄固有のギャップしやすさの文脈に相対化 |
| `mkt_return_1d` | `gap_market_align` | 市場との一致・乖離を組み合わせ特徴量化 |
| `atr_14` | `gap_vs_atr` | ボラティリティ正規化に利用 |

---

## 実装上の注意点

1. **ルックアヘッドバイアス防止**
   - `gap_ratio` は当日始値（Open）を使うため、ターゲット生成と同じ行の値を使っている
   - 特徴量として使う場合は **前日の** ギャップを参照すること（`.shift(1)` が必要かを要確認）
   - ただし日中騰落率予測では「当日のギャップ」が予測に直結するため、
     当日始値が確定した時点で計算する設計なら問題なし

2. **欠損値処理**
   - 上場初日など前日終値がない場合は `gap_ratio` が NaN になる → `fillna(0)` で対処

3. **外れ値処理**
   - ストップ高・ストップ安（±20%超）は制限値幅による特殊値
   - `gap_vs_atr` のクリッピングを検討（例: ±5 でクリップ）

---

## 期待される効果

| モデル | 現状 | 期待 |
|--------|------|------|
| 日中騰落率 方向的中率 | 54.1% | 55〜56% |
| Sharpe Ratio | 0.68〜1.41 | 1.0〜1.5 |

`gap_abs` と `gap_vs_atr` は日中騰落率の符号（上昇/下落）と強い非線形相関を持つと考えられ、
特に方向的中率の向上に貢献することが期待される。

---

## 実装優先順位

1. `gap_abs` — 計算コストゼロ、即効性高
2. `gap_vs_atr` — ATR比で相対化、フィル判定に有効
3. `gap_market_align` — 市場との一致度、モメンタム継続の識別に有効
4. `gap_abs_rank` — クロスセクショナル処理が必要、実装コスト中

---

## 次のアクション

1. `engineer.py` の `build_features` 内に上記コードを追加
2. `build_features_all` で `gap_abs_rank` のクロスセクショナル計算を追加
3. 多目的最適化完了後、ベストパラメータで再学習してバックテスト比較
4. feature importance gain で各特徴量の寄与を確認し `feature_evaluation.md` を更新
