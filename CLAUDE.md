# デイトレーダー支援システム

## プロジェクト概要

東証全銘柄（プライム・スタンダード・グロース）を対象に、翌営業日の株価（始値・終値）をAIで予測し、
当日中に決済するデイトレード向け銘柄を毎日推薦するシステム。

**元手**: 200万円
**取引スタイル**: 前場始値で取得 → 後場終値で売却 → 当日精算（持ち越しなし）

---

## 取引ルール

- **買い**: 前場寄り付き（09:00 頃）に成行 or 指値で取得
- **売り**: 後場引け（15:30）までに必ず決済
- **持ち越し禁止**: 当日中にすべて清算
- **対象市場**: 東証プライム / スタンダード / グロース の全上場銘柄
- **資金管理**: 1銘柄あたりの投資上限を元手の20%以内（400,000円）に抑える

---

## システム構成

```
trader/
├── CLAUDE.md
├── requirements.txt
├── config.py                  # 設定値（資金・リスク・モデルパラメータ）
├── data/
│   ├── raw/                   # Yahoo Finance から取得した生データ（日次更新）
│   ├── processed/             # 特徴量エンジニアリング済みデータ
│   └── tickers/
│       └── tse_tickers.csv    # 東証全銘柄コード・単元株数一覧
├── src/
│   ├── fetch/
│   │   ├── tickers.py         # 東証銘柄コード取得（JPX 公式 or スクレイピング）
│   │   ├── prices.py          # Yahoo Finance から1年分の OHLCV 取得
│   │   └── lot_size.py        # 単元株数取得
│   ├── features/
│   │   └── engineer.py        # テクニカル指標・特徴量生成
│   ├── models/
│   │   ├── train.py           # モデル学習
│   │   ├── predict.py         # 翌日の始値・終値予測
│   │   └── evaluate.py        # バックテスト・精度評価
│   ├── strategy/
│   │   └── recommend.py       # 予測値から推薦銘柄リスト生成
│   └── report/
│       └── output.py          # 推薦結果を CSV / Markdown で出力
├── notebooks/                 # 探索・分析用 Jupyter notebook
├── scripts/
│   └── daily_run.sh           # 毎日自動実行するエントリポイント
└── results/
    └── YYYY-MM-DD/            # 日付ごとの推薦結果・予測精度ログ
```

---

## データ取得仕様

### 銘柄コード取得
- JPX（日本取引所グループ）の公開ファイルから東証全銘柄コードを取得する
  - URL: `https://www.jpx.co.jp/markets/statistics-equities/misc/01.html`（上場銘柄一覧 Excel）
  - または `pandas_datareader` / `yfinance` で補完
- Yahoo Finance での東証銘柄コード形式: `{4桁コード}.T`（例: `7203.T` = トヨタ）

### 株価履歴取得（`yfinance` 使用）
```python
import yfinance as yf
ticker = yf.Ticker("7203.T")
df = ticker.history(period="1y")  # 直近1年分の OHLCV
```
- 取得項目: Open, High, Low, Close, Volume
- 取得頻度: 毎営業日の引け後（15:30 以降）に実行
- エラー時: リトライ3回、失敗した銘柄はログに記録してスキップ

### 単元株数取得
```python
info = yf.Ticker("7203.T").info
lot_size = info.get("lotSize", 100)  # 取得できない場合は100株をデフォルト
```
- `info["lotSize"]` が取れない場合は JPX データから補完する

---

## 特徴量エンジニアリング

以下のテクニカル指標を特徴量として使用する（`ta` または `pandas_ta` ライブラリ推奨）:

| カテゴリ | 指標 |
|----------|------|
| トレンド | SMA(5, 20, 60), EMA(12, 26), MACD, ADX |
| モメンタム | RSI(14), Stochastic(14), Williams %R |
| ボラティリティ | ATR(14), Bollinger Bands(20), 標準偏差 |
| 出来高 | OBV, 出来高移動平均比, 出来高前日比 |
| 価格変化 | 前日比騰落率, 始値-終値ギャップ, 高値-安値レンジ |

---

## 予測モデル

### 予測ターゲット
1. **翌日の始値**（前日終値からの変化率）
2. **翌日の終値**（前日終値からの変化率）
3. **期待利益幅** = 翌日終値予測 - 翌日始値予測

### モデル選定の考え方

株価予測の難しさの本質はモデルの複雑さではなく、**シグナル/ノイズ比の低さ**にある。
方向的中率 55% 以上を実用ラインとし、段階的にモデルを高度化する。

> 参考: "Are Transformers Effective for Time Series Forecasting?"（2022）では、
> 単純な線形モデルが多くのベンチマークで Transformer を上回った。
> モデルの複雑さよりも特徴量品質と過学習抑制が重要。

### フェーズ別モデル構成

#### フェーズ1（初期実装）: LightGBM ベースライン
- 3,900銘柄 × 毎日の推論が高速
- 特徴量重要度で「何が効いているか」を確認できる
- 過学習しにくく、ハイパーパラメータ調整が容易
- **限界**: 時間の順序を直接扱えない（ラグ特徴量で補完が必要）

#### フェーズ2（精度改善）: Temporal Fusion Transformer (TFT)
- ライブラリ: `pytorch-forecasting`
- 複数銘柄を **1モデルで**学習できる（銘柄コードを静的共変量として入力）
- 始値・終値の **マルチホライズン同時予測**が得意
- Attention の可視化で「どの過去期間が影響したか」を解釈できる
- iTransformer（2024）も候補: 多変量時系列において変数軸で Attention をかける逆転発想

#### フェーズ3（実験的）: 時系列基盤モデルのファインチューニング
- **Chronos**（Amazon, 2024）: LLM アーキテクチャを時系列に応用した事前学習済みモデル
- **TimesFM**（Google, 2024）: 大規模コーパスで事前学習済み
- 1銘柄あたりのデータが少ない（約250日）場合に汎化性能で有利になる可能性がある

### 学習方針
- 全銘柄共通モデルで実装し、精度不足なら銘柄セクター別に個別化
- 学習データ: 直近1年分（約250営業日）
- バリデーション: ウォークフォワード検証（最後の20日間をテストセットとして保持）
- 再学習: 週1回、または方向的中率が 52% を下回ったとき

---

## 推薦ロジック

```python
# 推薦スコア計算
expected_gain_pct = (predicted_close - predicted_open) / predicted_open * 100

# フィルタ条件（これらを満たす銘柄のみ対象）
filters = {
    "min_volume": 100_000,          # 流動性確保（出来高10万株以上）
    "min_expected_gain_pct": 0.5,   # 期待上昇率0.5%以上
    "max_price": 400_000,           # 元手の20%以内で最低1単元買える株価
    "max_price_volatility": 10.0,   # 前日比±10%超のギャップアップ/ダウン銘柄は除外
}

# ソート: 期待利益幅が大きい順
recommendations = df.sort_values("expected_gain_pct", ascending=False).head(20)
```

### 出力項目（推薦リスト）
| 項目 | 説明 |
|------|------|
| コード | 銘柄コード（例: 7203） |
| 銘柄名 | 企業名 |
| 市場区分 | プライム / スタンダード / グロース |
| 予測始値 | 翌日の推定始値（円） |
| 予測終値 | 翌日の推定終値（円） |
| 期待上昇率 | (終値-始値)/始値 × 100（%） |
| 期待利益額 | 1単元あたりの期待利益（円） |
| 単元株数 | 1単元の株数 |
| 必要資金 | 1単元購入に必要な概算金額（円） |
| 出来高(前日) | 流動性確認用 |

---

## 毎日の実行フロー

```
[引け後 15:30〜]
  1. 東証銘柄コード一覧を更新（週1回で可）
  2. 全銘柄の直近1年 OHLCV を Yahoo Finance から取得（並列処理推奨）
  3. 特徴量エンジニアリング
  4. モデルで翌日の始値・終値を予測
  5. フィルタリング・スコアリング・ソート
  6. results/YYYY-MM-DD/ に推薦リストを出力
  7. （オプション）前日の予測精度をログに記録
```

---

## 技術スタック

| 用途 | ライブラリ |
|------|-----------|
| データ取得 | `yfinance`, `requests`, `pandas` |
| テクニカル指標 | `pandas_ta` または `ta` |
| 機械学習 | `lightgbm`, `scikit-learn` |
| 深層学習（フェーズ2）| `pytorch-forecasting` (TFT), `torch` (iTransformer) |
| 深層学習（フェーズ3）| `autogluon-timeseries` (Chronos), `timesfm` (TimesFM) |
| データ処理 | `pandas`, `numpy` |
| 並列処理 | `concurrent.futures`, `joblib` |
| スケジューリング | `cron` (Linux/mac) または `APScheduler` |
| 可視化 | `matplotlib`, `plotly` |

---

## 開発上の注意事項

### 東証固有の事情
- **制限値幅（ストップ高/安）**: 前日終値に応じた制限値幅があり、超過すると売買停止になる
- **信用倍率**: 空売り残と買い残の比率が需給の判断材料になる（取得可能なら特徴量に追加）
- **決算発表**: 決算前後は異常な値動きになりやすい → 決算発表日の銘柄はフィルタで除外を検討
- **祝日**: 東証の休場日は `jpbizday` または手動カレンダーで管理

### Yahoo Finance の制限
- 無料APIのため、大量リクエストはレートリミットに注意
- 全銘柄（約3,900銘柄超）を取得する場合は `time.sleep` を挟みながら並列数を制限する
- 取得できなかった銘柄は警告ログを残し、処理をスキップする

### リスク管理
- 1銘柄への集中投資は禁止（上限: 元手の20% = 400,000円）
- 損切りライン: 始値から-2%で即売却（システム外での手動ルールとして記録）
- 推薦システムはあくまで**参考情報**であり、最終判断はトレーダー本人が行う

---

## コーディング規約

- 言語: **Python 3.11+**
- フォーマッター: `ruff format`
- リンター: `ruff check`
- 型ヒント: 関数シグネチャには必ず付ける
- ログ: `logging` モジュールを使用（`print` は禁止）
- テスト: `pytest`、カバレッジは主要ロジックに対して実施
- 環境変数: API キーや秘匿情報は `.env` ファイルで管理（`.gitignore` に追加）

---

## バックテスト評価指標

| 指標 | 説明 |
|------|------|
| 方向的中率 | 上昇/下落の方向が合っていた割合 |
| RMSE | 価格予測の二乗平均平方根誤差 |
| 期待収益率 | バックテスト期間の平均日次リターン |
| 最大ドローダウン | 資金ピークからの最大下落率 |
| Sharpe Ratio | リスク調整後リターン |
